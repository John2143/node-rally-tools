{"version":3,"file":"bundle.js","sources":["src/rally-tools.js","src/preset.js","src/rule.js","src/index.js","src/cli.js"],"sourcesContent":["import rp from \"request-promise\";\nimport chalk from \"chalk\";\n\nglobal.chalk = chalk;\nglobal.log = text => console.log(text);\nglobal.write = text => process.stdout.write(text);\nglobal.errorLog = text => log(chalk.red(text));\n\nexport class lib{\n    static async makeAPIRequest({env, path, path_full, payload, body, json = true, method = \"GET\", qs, headers = {}, fullResponse = false}){\n        //Keys are defined in enviornment variables\n        let rally_api_key = process.env[`rally_api_key_${env}`];\n        let rally_api = process.env[`rally_api_url_${env}`];\n\n        if(!rally_api && !path_full) return errorLog(`Unsupported env ${env}`);\n\n        path = path_full || rally_api + path;\n        body = body || payload && JSON.stringify(payload);\n\n        if(global.logAPI){\n            log(chalk`${method} @ ${path}`);\n            if(qs){\n                log(qs)\n            }\n        }\n        if(payload){\n            headers[\"Content-Type\"] = \"application/vnd.api+json\";\n        }\n\n        let requestOptions = {\n            method, body, qs, uri: path,\n            auth: {bearer: rally_api_key},\n            headers: {\n                Accept: \"application/vnd.api+json\",\n                ...headers,\n            },\n            simple: false, resolveWithFullResponse: true,\n        };\n        let response = await rp(requestOptions);\n\n        if(!fullResponse && ![200, 201, 204].includes(response.statusCode)){\n            throw new APIError(response, requestOptions);\n        }\n        if(fullResponse){\n            return response;\n        }else if(json){\n            return JSON.parse(response.body);\n        }else{\n            return response.body;\n        }\n    }\n    //Index a json endpoint that returns a {links} field.\n    static async indexPath(env, path){\n        let all = [];\n\n        let json = await this.makeAPIRequest({env, path});\n\n        let [numPages, pageSize] = this.numPages(json.links.last);\n        //log(`num pages: ${numPages} * ${pageSize}`);\n\n        all = [...json.data];\n        while(json.links.next){\n            json = await this.makeAPIRequest({env, path_full: json.links.next});\n            all = [...all, ...json.data];\n        }\n\n        return all;\n    }\n\n    //Returns number of pages and pagination size\n    static numPages(str){\n        return /page=(\\d+)p(\\d+)/.exec(str).slice(1);\n    }\n\n    //Index a json endpoint that returns a {links} field.\n    //\n    //This function is faster than indexPath because it can guess the pages it\n    //needs to retreive so that it can request all assets at once.\n    //\n    //This function assumes that the content from the inital request is the\n    //first page, so starting on another page may cause issues. Consider\n    //indexPath for that.\n    static async indexPathFast(env, path){\n        let all = [];\n\n        let json = await this.makeAPIRequest({env, path});\n        let baselink = json.links.first;\n        const linkToPage = page => baselink.replace(\"page=1p\", `page=${page}p`);\n\n        let [numPages, pageSize] = this.numPages(json.links.last);\n        //log(`num pages: ${numPages} * ${pageSize}`);\n\n        //Construct an array of all the requests that are done simultanously.\n        //Assume that the content from the inital request is the first page.\n        let promises = [Promise.resolve(json),];\n        for(let i = 2; i <= numPages; i++){\n            let req = this.makeAPIRequest({env, path_full: linkToPage(i)});\n            promises.push(req);\n        }\n\n        for(let promise of promises){\n            all = [...all, ...(await promise).data];\n        }\n\n        return all;\n    }\n};\n\nexport class AbortError extends Error{\n    constructor(message){\n        super(message);\n        Error.captureStackTrace(this, this.constructor);\n        this.name = \"AbortError\";\n    }\n}\n\nexport class APIError extends Error{\n    constructor(response, opts){\n        super(chalk`\n{reset Request returned} {yellow ${response.statusCode}}\n{green ${JSON.stringify(opts)}}\n{reset ${response.body}}\n        `);\n        Error.captureStackTrace(this, this.constructor);\n        this.name = \"ApiError\";\n    }\n}\n","import fs from \"fs\";\nimport {lib, AbortError} from  \"./rally-tools.js\";\nimport {basename} from \"path\";\n\nlet envs = {};\nexport default class Preset{\n    constructor({path, remote, data}){\n        this.remote = remote\n        if(!this.remote){\n            this.path = path;\n            try{\n                this.code = this.getLocalCode();\n            }catch(e){\n                log(chalk`{red Node Error} e.message`);\n                throw new AbortError(\"Could not load code of local file\");\n            }\n            this.name = this.parseFilenameForName() || this.parseCodeForName();\n        }else{\n            this.name = data.attributes.name;\n            this.id = data.id;\n            this.rawData = data;\n        }\n    }\n    chalkPrint(){\n        let id = String(this.remote && this.remote + \"-\" + this.id || \"Local\").padStart(8);\n        return chalk`{green ${id}}: {blue ${this.name}}`;\n    }\n    parseFilenameForName(){\n        if(this.path.endsWith(\".jinja\") || this.path.endsWith(\".json\")){\n            return basename(this.path)\n                .replace(\"_\", \" \")\n                .replace(\"-\", \" \");\n        }\n    }\n    parseCodeForName(){\n        const name_regex = /name:\\s([\\w\\d. \\/]+)[\\r\\s\\n]*?/;\n        const match = name_regex.exec(this.code);\n        if(match) return match[1];\n    }\n    findStringsInCode(strings){\n        if(!this.code) return [];\n\n        return strings.filter(str => {\n            let regex = new Regexp(str);\n            return !!this.code.match(regex);\n        });\n    }\n    getPath(){\n        return `${process.env.rally_repo_path}/silo-presets/${this.name}.${this.ext}`;\n    }\n    getMetadataPath(){\n        return `${process.env.rally_repo_path}/silo-metadata/${this.name}.json`;\n    }\n    codeBinary(){\n        if(this.code.startsWith(\"=BASE64=\")){\n            return bota(this.code.substring(8));\n        }else{\n            return this.code;\n        }\n    }\n    async uploadPresetData(env, id){\n        let res = await lib.makeAPIRequest({\n            env, path: `/presets/${id}/providerData`,\n            body: this.code, method: \"PUT\", fullResponse: true\n        });\n        write(chalk`response {yellow ${res.statusCode}}`);\n    }\n    async uploadCodeToEnv(env, createFunction){\n        write(chalk`Uploading {green ${this.name}} to {green ${env}}: `);\n\n        //First query the api to see if this already exists.\n        let res = await lib.makeAPIRequest({\n            env, path: `/presets`,\n            qs: {filter: `name=${this.name}`},\n        });\n        let remote = res.data[0];\n\n        if(remote){\n            //If it exists we can replace it\n            write(\"replace, \");\n            await this.uploadPresetData(env, remote.id);\n        }else{\n            //If it needs to be created then we need to ask the user for metadata\n            write(\"create, \");\n            let metadata = await createFunction(this);\n            write(\"Posting to create preset... \");\n            let res = await lib.makeAPIRequest({\n                env, path: `/presets`, method: \"POST\",\n                payload: {data: metadata},\n            });\n            let id = res.data.id;\n            write(chalk`Created id {green ${id}}... Uploading Code... `);\n            await this.uploadPresetData(env, id);\n        }\n        log();\n    }\n\n    constructMetadata(providerID){\n        return {\n            attributes: {\n                name: this.name,\n                //providerSettings: {\n                //},\n            },\n            relationships: {\n                providerType: {\n                    data: {\n                        id: providerID,\n                        type: \"providerTypes\",\n                    },\n                }\n            },\n            type: \"presets\"\n        };\n    }\n\n    getMetadata(){}\n    getLocalCode(){\n        return fs.readFileSync(this.path, \"utf-8\");\n    }\n\n    static envs(env){\n        return envs[env] = envs[env] || Preset.cache_envs(env);\n    }\n    static cache_env(env){\n\n    }\n}\n","export default class Rule{\n    constructor(data, remote){\n        this.rawData = data;\n        this.remote = remote;\n    }\n    chalkPrint(){\n        let D = this.rawData;\n        let id = String(this.remote + \"-\" + D.id).padStart(8);\n        return chalk`{green ${id}}: {blue ${D.attributes.name}}`;\n    }\n}\n","import {lib} from \"./rally-tools.js\";\n\nexport {default as Preset} from \"./preset.js\";\nexport {default as Rule} from \"./rule.js\";\nexport * from \"./rally-tools.js\";\n\nexport const rallyFunctions = {\n    async bestPagintation(){\n        global.silentAPI = true;\n        for(let i = 10; i <= 30; i+=5){\n            console.time(\"test with \" + i);\n            let dl = await lib.indexPathFast(\"DEV\", `/workflowRules?page=1p${i}`);\n            console.timeEnd(\"test with \" + i);\n        }\n    },\n    async uploadPresets(env, presets, createFunc = ()=>false){\n        for(let preset of presets){\n            await preset.uploadCodeToEnv(env, createFunc);\n        }\n    },\n    async getProviders(env){\n        let providers = await lib.indexPath(env, \"/providerTypes?page=1p50\");\n        providers = providers.sort((a, b) => {\n            return a.attributes.category.localeCompare(b.attributes.category) ||\n                   a.attributes.name    .localeCompare(b.attributes.name);\n        });\n        return providers;\n    },\n    async getEditorConfig(env, provider){\n        let config = await lib.makeAPIRequest({env, path_full: provider.links.editorConfig});\n        let helpText = config.helpText;\n        config.helpText = () => helpText;\n        return config\n    },\n    async getRules(env){\n        let rules = await lib.indexPathFast(env, \"/workflowRules?page=1p20\");\n        return rules;\n    },\n    async getPresets(env){\n        let rules = await lib.indexPathFast(env, \"/presets?page=1p20\");\n        return rules;\n    },\n}\n","require(\"source-map-support\").install();\n\nimport argparse from \"minimist\";\nimport {rallyFunctions as funcs, Preset, Rule, AbortError} from \"./index.js\";\nimport inquirer from \"inquirer\";\n\nlet argv = argparse(process.argv.slice(2), {\n    string: [\"file\", \"env\"],\n    alias: {\n        f: \"file\", e: \"env\",\n    }\n});\n\nfunction prettyPrintProvider(pro){\n    let id = String(pro.id).padStart(4);\n    return chalk`{green ${id}}: {blue ${pro.attributes.category}} - {green ${pro.attributes.name}}`;\n}\n\nlet help = {\n};\n\nlet helpEntry = name => help[name] ? help[name] : (help[name] = {name});\n\nfunction helpText(text){\n    return function(func, name){\n        helpEntry(name).text = text;\n        return func;\n    }\n}\nfunction arg(long, short, desc){\n    return function(func, name){\n        let args = helpEntry(name).args = helpEntry(name).args || [];\n        args.unshift({long, short, desc});\n        return func;\n    }\n}\nfunction param(param, desc){\n    return function(func, name){\n        let params = helpEntry(name).params = helpEntry(name).params || [];\n        params.unshift({param, desc});\n        return func;\n    }\n}\nfunction usage(usage){\n    return function(func, name){\n        usage = usage.replace(/[\\[<](\\w+)[\\]>]/g, chalk`[{blue $1}]`);\n        helpEntry(name).usage = usage;\n        return func;\n    }\n}\n\nfunction printHelp(help, short){\n    let helpText = chalk`\n{white ${help.name}}: ${help.text}\n    Usage: ${help.usage || \"<unknown>\"}\n`\n    //Trim newlines\n    helpText = helpText.substring(1, helpText.length-1);\n\n    if(!short){\n        for(let param of help.params || []){\n            helpText += chalk`\\n    {blue ${param.param}}: ${param.desc}`\n        }\n        for(let arg of help.args || []){\n            helpText += chalk`\\n    {blue ${arg.short}}, {blue ${arg.long}}: ${arg.desc}`\n        }\n    }\n\n    return helpText;\n}\n\nlet cli = {\n    @helpText(`Display the help menu`)\n    @usage(`rally help [subhelp]`)\n    @param(\"subhelp\", \"The name of the command to see help for\")\n    async help(){\n        let arg = argv._[1];\n        if(arg){\n            log(printHelp(help[arg]));\n        }else{\n            for(let arg in help){\n                log(printHelp(help[arg], true));\n            }\n        }\n    },\n\n    @helpText(`Print input args, for debugging`)\n    async printArgs(args){\n        log(args);\n    },\n\n    @helpText(`Preset related actions`)\n    @usage(`rally preset [action] --env [enviornment] --file [file1] --file [file2] ...`)\n    @param(\"action\", \"The action to perform. Can be upload or list\")\n    @arg(\"-e\", \"--env\", \"The enviornment you wish to perform the action on\")\n    @arg(\"-f\", \"--file\", \"A file to act on\")\n    async preset(args){\n        let env = args.env;\n        let arg = argv._[1];\n        if(arg === \"upload\"){\n            let files = args.file;\n            if(!files){\n                throw new AbortError(\"No files provided to upload (use --file argument)\");\n            }\n            if(typeof files === \"string\") files = [files];\n            log(chalk`Uploading {green ${files.length}} preset(s) to {green ${env}}.`);\n\n            let presets = files.map(path => new Preset({path, remote: false}));\n            await funcs.uploadPresets(args.env, presets, async preset => {\n                log(\"asking... \");\n                let provider = await this[\"select-provider\"](args);\n                return preset.constructMetadata(provider.id);\n            });\n        }else if(arg === \"list\"){\n            log(\"Loading...\");\n            let presets = await funcs.getPresets(env);\n            log(chalk`{yellow ${presets.length}} presets on {green ${env}}.`);\n            for(let data of presets) log(new Preset({data, remote: env}).chalkPrint());\n        }else{\n            log(chalk`Unknown action {red ${arg}} try '{white rally help preset}'`);\n        }\n        //log(presets);\n    },\n\n    @helpText(`Rule related actions`)\n    @usage(`rally rule [action] --env [enviornment]`)\n    @param(\"action\", \"The action to perform. Only list is supported right now\")\n    @arg(\"-e\", \"--env\", \"The enviornment you wish to perform the action on\")\n    async rule(args){\n        let env = args.env;\n        let arg = argv._[1];\n\n        if(arg === \"list\"){\n            log(\"Loading...\");\n            let rules = await funcs.getRules(env);\n            log(chalk`{yellow ${rules.length}} rules on {green ${env}}.`);\n            for(let data of rules) log(new Rule(data, env).chalkPrint());\n        }else{\n            log(chalk`Unknown action {red ${arg}} try '{white rally help rule}'`);\n        }\n    },\n\n    @helpText(`List all available providers, or find one by name/id`)\n    @usage(`rally providers [identifier] --env [env]`)\n    @param(\"identifier\", \"Either the name or id of the provider\")\n    @arg(\"-e\", \"--env\", \"The enviornment you wish to perform the action on\")\n    async providers(args){\n        let env = args.env;\n        let ident = argv._[1];\n\n        let providers = await funcs.getProviders(env);\n\n        if(ident){\n            let pro = providers.find(x => x.id == ident || x.attributes.name.includes(ident));\n            if(!pro){\n                log(chalk`Couldn't find provider by {green ${ident}}`);\n            }else{\n                log(prettyPrintProvider(pro));\n                log(await funcs.getEditorConfig(env, pro));\n            }\n        }else{\n            for(let pro of providers) log(prettyPrintProvider(pro));\n        }\n    },\n    async [\"select-provider\"](args){\n        let env = args.env;\n\n        let providers = await funcs.getProviders(env);\n        let defaultProvider =  providers.find(x => x.attributes.name === \"SdviEvaluate\");\n        if(args.defaultSelect){\n            return defaultProvider;\n        }else{\n            let q = await inquirer.prompt([{\n                type: \"list\",\n                name: \"provider\",\n                default: defaultProvider,\n                choices: providers.map(x => ({\n                    name: prettyPrintProvider(x),\n                    value: x,\n                })),\n            },]);\n            return q.provider;\n        }\n    },\n};\n\nasync function $main(){\n    let func = argv._[0];\n    if(cli[func]){\n        try{\n            let ret = await cli[func](argv);\n            if(ret){\n                write(chalk.white(\"CLI returned: \"));\n                log(ret);\n            }\n        }catch(e){\n            if(e instanceof AbortError){\n                log(chalk`{red CLI Aborted}: ${e.message}`);\n            }else{\n                throw e;\n            }\n        }\n    }else{\n        log(`Unknown command '${func}'. Try 'help'`);\n    }\n}\n\nasync function main(...args){\n    try{\n        await $main(...args);\n    }catch(e){\n        errorLog(e.stack);\n    }\n}\n\nmain();\n"],"names":["global","chalk","log","text","console","write","process","stdout","errorLog","red","lib","makeAPIRequest","env","path","path_full","payload","body","json","method","qs","headers","fullResponse","rally_api_key","rally_api","JSON","stringify","logAPI","requestOptions","uri","bearer","resolveWithFullResponse","response","rp","includes","statusCode","APIError","parse","indexPath","all","numPages","pageSize","links","last","data","next","str","exec","slice","indexPathFast","baselink","first","linkToPage","page","replace","promises","Promise","resolve","i","req","push","promise","AbortError","Error","message","captureStackTrace","constructor","name","opts","envs","Preset","remote","code","getLocalCode","e","parseFilenameForName","parseCodeForName","attributes","id","rawData","String","padStart","endsWith","basename","name_regex","match","strings","filter","regex","Regexp","rally_repo_path","ext","startsWith","bota","substring","uploadPresetData","res","uploadCodeToEnv","createFunction","metadata","providerID","fs","readFileSync","cache_envs","cache_env","Rule","D","rallyFunctions","bestPagintation","silentAPI","time","dl","timeEnd","uploadPresets","presets","createFunc","preset","getProviders","providers","sort","a","b","category","localeCompare","getEditorConfig","provider","config","editorConfig","helpText","getRules","rules","getPresets","require","install","argv","argparse","prettyPrintProvider","pro","help","helpEntry","func","arg","long","short","desc","args","unshift","param","params","usage","printHelp","length","cli","_","printArgs","files","file","map","funcs","constructMetadata","chalkPrint","rule","ident","find","x","defaultProvider","defaultSelect","q","inquirer","prompt","$main","ret","white","main","stack"],"mappings":"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"}